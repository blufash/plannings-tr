<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Planning Trains</title>
<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; color:#333; text-align:center; padding:20px; }
h1 { color:#0077cc; }
.tabs { margin:20px 0; }
.tab { display:inline-block; margin:5px; padding:10px 15px; background:#ddd; border-radius:5px; cursor:pointer; }
.tab.active { background:#0077cc; color:#fff; }
form { margin:15px 0; background:#fff; padding:10px; border-radius:8px; display:inline-block; }
input, button { padding:7px; margin:5px; border-radius:5px; border:1px solid #ccc; }
ul { list-style:none; padding:0; }
li { background:#fff; margin:5px auto; padding:10px; border-radius:6px; width:320px; box-shadow:0 0 4px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
.actions button { margin-left:5px; }
</style>
</head>
<body>

<h1>🚂 Planning des trains</h1>

<div class="tabs" id="joursTabs"></div>

<form id="trainForm">
  <input type="text" id="numero" placeholder="Numéro de train (ex: EVO5525)" pattern="[A-Za-z0-9]+" required>
  <input type="time" id="horaire" required>
  <button type="submit">Ajouter</button>
</form>

<ul id="listeTrains"></ul>

<audio id="alarme" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD-lFAelCOh-UUAK7S8MsaxDnzekrsUTcQ",
    authDomain: "accord-depart.firebaseapp.com",
    projectId: "accord-depart",
    storageBucket: "accord-depart.appspot.com",
    messagingSenderId: "972478403471",
    appId: "1:972478403471:web:e8c2792b526557c03df1fa",
    measurementId: "G-EBR6WFVC0Y"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
  const tabs = document.getElementById('joursTabs');
  const liste = document.getElementById('listeTrains');
  const form = document.getElementById('trainForm');
  const alarme = document.getElementById('alarme');

  let jourActif = jours[new Date().getDay()-1] || "Dimanche"; 

  // Onglets
  jours.forEach(jour => {
    const tab = document.createElement('div');
    tab.textContent = jour;
    tab.classList.add('tab');
    if(jour === jourActif) tab.classList.add('active');
    tab.onclick = () => { jourActif = jour; majTabs(); afficherTrains(); };
    tabs.appendChild(tab);
  });

  function majTabs(){
    Array.from(tabs.children).forEach(t => {
      t.classList.toggle('active', t.textContent===jourActif);
    });
  }

  function afficherTrains(){
    liste.innerHTML = "";
    db.collection("trains")
      .where("jour", "==", jourActif)
      .orderBy("horaire")
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const t = doc.data();
          const li = document.createElement('li');
          li.innerHTML = `<span>Train ${t.numero} - ${t.horaire}</span>`;
          const actions = document.createElement('div');
          actions.className="actions";

          const btnEdit = document.createElement('button');
          btnEdit.textContent="✏️";
          btnEdit.onclick = () => modifierTrain(doc.id, t);

          const btnDel = document.createElement('button');
          btnDel.textContent="🗑️";
          btnDel.onclick = () => supprimerTrain(doc.id);

          actions.appendChild(btnEdit);
          actions.appendChild(btnDel);
          li.appendChild(actions);
          liste.appendChild(li);
        });
      });
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const numero = document.getElementById('numero').value.trim();
    const horaire = document.getElementById('horaire').value;

    if(!numero.match(/^[A-Za-z0-9]+$/) || !horaire) return;

    db.collection("trains").add({
      numero,
      horaire,
      jour: jourActif,
      triggered: false
    }).then(() => {
      afficherTrains();
      form.reset();
    });
  });

  function modifierTrain(id, train){
    const nouveauNumero = prompt("Nouveau numéro ?", train.numero);
    const nouvelHoraire = prompt("Nouvel horaire (HH:MM) ?", train.horaire);
    if(nouveauNumero && nouvelHoraire.match(/^\d{2}:\d{2}$/)){
      db.collection("trains").doc(id).update({
        numero: nouveauNumero,
        horaire: nouvelHoraire,
        triggered: false
      }).then(() => afficherTrains());
    }
  }

  function supprimerTrain(id){
    if(confirm("Êtes-vous sûr de vouloir supprimer ce train ?")){
      db.collection("trains").doc(id).delete().then(() => afficherTrains());
    }
  }

  function checkAlarme(){
    const now = new Date();
    const heureActuelle = now.toTimeString().slice(0,5);
    const jourCourant = jours[now.getDay()-1] || "Dimanche";

    db.collection("trains")
      .where("jour", "==", jourCourant)
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const t = doc.data();
          if(t.horaire === heureActuelle && !t.triggered){
            doc.ref.update({triggered:true});
            alarme.play();
            alert(`🚂 Train ${t.numero} (${jourCourant} - ${t.horaire}) !`);
          }
        });
      });
  }

  function resetTriggers(){
    db.collection("trains").get().then(snapshot => {
      snapshot.forEach(doc => doc.ref.update({triggered:false}));
    });
  }

  setInterval(checkAlarme, 1000);
  setInterval(resetTriggers, 24*60*60*1000);

  afficherTrains();
</script>
</body>
</html>
