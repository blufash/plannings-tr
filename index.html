<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning Trains</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; color:#333; text-align:center; padding:20px; }
    h1 { color:#0077cc; margin: 0 0 10px; }
    .tabs { margin:20px 0; }
    .tab { display:inline-block; margin:5px; padding:10px 15px; background:#ddd; border-radius:5px; cursor:pointer; user-select:none; }
    .tab.active { background:#0077cc; color:#fff; }
    form { margin:15px 0; background:#fff; padding:10px; border-radius:8px; display:inline-block; box-shadow:0 0 4px rgba(0,0,0,0.08); }
    input, button { padding:7px 10px; margin:5px; border-radius:5px; border:1px solid #ccc; }
    #enableSound { background:#ffe8b3; border-color:#e6c779; }
    ul { list-style:none; padding:0; }
    li { background:#fff; margin:6px auto; padding:10px; border-radius:6px; width:340px; box-shadow:0 0 4px rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; }
    .actions button { margin-left:6px; }
  </style>
</head>
<body>

  <h1>üöÇ Accordd√©part üöÇ </h1>

  <div class="tabs" id="joursTabs"></div>

  <form id="trainForm">
    <input type="text" id="numero" placeholder="Num√©ro de train (ex: EVO5525)" pattern="[A-Za-z0-9]+" required />
    <input type="time" id="horaire" required />
    <button type="submit">Ajouter</button>
  </form>

  <!-- Bouton pour autoriser son & notifications (obligatoire une fois) -->
  <div>
    <button id="enableSound">üîä Activer son & notifications</button>
  </div>

  <ul id="listeTrains"></ul>

  <!-- Son local h√©berg√© dans /sounds/alarme.mp3 -->
  <audio id="alarme" src="sounds/alarme.mp3" preload="auto" loop></audio>

  <!-- Firebase compat (pour site HTML simple) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Config Firebase (du projet accord-depart-48400) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCJNVjAS8-hqW6KBcewBzUHXc6gbz1hj9c",
      authDomain: "accord-depart-48400.firebaseapp.com",
      projectId: "accord-depart-48400",
      storageBucket: "accord-depart-48400.appspot.com", // important: .appspot.com
      messagingSenderId: "996894868266",
      appId: "1:996894868266:web:1829dd1f375ce99a099453",
      measurementId: "G-J636KCRMFY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== R√©f√©rences DOM =====
    const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
    const tabs = document.getElementById('joursTabs');
    const liste = document.getElementById('listeTrains');
    const form = document.getElementById('trainForm');
    const alarme = document.getElementById('alarme');
    const enableBtn = document.getElementById('enableSound');

    // ===== Son & notifications : activation une fois =====
    let audioReady = false;
    enableBtn.addEventListener("click", async () => {
      try {
        await alarme.play();           // d√©verrouille l'audio
        alarme.pause();
        alarme.currentTime = 0;
        audioReady = true;
      } catch(e) {
        alert("Autorise le son pour ce site dans ton navigateur.");
      }
      if ("Notification" in window && Notification.permission !== "granted") {
        try { await Notification.requestPermission(); } catch(e) {}
      }
      enableBtn.style.display = "none";
    });

    // ===== Jour courant & onglets =====
    function jourCourant() {
      const i = new Date().getDay(); // 0=Dimanche, 1=Lundi...
      return i === 0 ? "Dimanche" : jours[i-1];
    }
    let jourActif = jourCourant();

    jours.forEach(jour => {
      const tab = document.createElement('div');
      tab.textContent = jour;
      tab.classList.add('tab');
      if (jour === jourActif) tab.classList.add('active');
      tab.onclick = () => { jourActif = jour; majTabs(); afficherTrains(); };
      tabs.appendChild(tab);
    });
    function majTabs(){
      Array.from(tabs.children).forEach(t => t.classList.toggle('active', t.textContent===jourActif));
    }

    // ===== Helpers =====
    function toTimeValue(hhmm){
      const [h,m] = hhmm.split(':').map(Number);
      return h*60 + m;
    }

    // ===== Affichage (tri par timeValue) =====
    async function afficherTrains(){
      liste.innerHTML = "";
      try {
        const snap = await db.collection("trains")
          .where("jour","==",jourActif)
          .orderBy("timeValue")
          .get();
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
        rows.forEach(renderRow);
      } catch(e) {
        // fallback si index composite manquant
        const snap = await db.collection("trains").where("jour","==",jourActif).get();
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
        rows.sort((a,b) => (a.timeValue ?? toTimeValue(a.horaire)) - (b.timeValue ?? toTimeValue(b.horaire)));
        rows.forEach(renderRow);
        console.warn("‚ö†Ô∏è Si Firestore demande un index, clique sur 'Create index' puis recharge.");
      }
    }

    function renderRow(t){
      const li = document.createElement('li');
      li.innerHTML = `<span>Train ${t.numero} - ${t.horaire}</span>`;
      const actions = document.createElement('div');
      actions.className="actions";

      const btnEdit = document.createElement('button');
      btnEdit.textContent="‚úèÔ∏è";
      btnEdit.onclick = () => modifierTrain(t.id, t);

      const btnDel = document.createElement('button');
      btnDel.textContent="üóëÔ∏è";
      btnDel.onclick = () => supprimerTrain(t.id);

      actions.appendChild(btnEdit);
      actions.appendChild(btnDel);
      li.appendChild(actions);
      liste.appendChild(li);
    }

    // ===== CRUD =====
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const numero = document.getElementById('numero').value.trim();
      const horaire = document.getElementById('horaire').value;
      if(!numero.match(/^[A-Za-z0-9]+$/) || !horaire) return;

      await db.collection("trains").add({
        numero,
        horaire,
        jour: jourActif,
        timeValue: toTimeValue(horaire),
        triggered: false
      });
      form.reset();
      afficherTrains();
    });

    async function modifierTrain(id, train){
      const nouveauNumero = prompt("Nouveau num√©ro ?", train.numero);
      const nouvelHoraire = prompt("Nouvel horaire (HH:MM) ?", train.horaire);
      if(nouveauNumero && /^\d{2}:\d{2}$/.test(nouvelHoraire)){
        await db.collection("trains").doc(id).update({
          numero: nouveauNumero,
          horaire: nouvelHoraire,
          timeValue: toTimeValue(nouvelHoraire),
          triggered: false
        });
        afficherTrains();
      }
    }

    async function supprimerTrain(id){
      if(confirm("√ätes-vous s√ªr de vouloir supprimer ce train ?")){
        await db.collection("trains").doc(id).delete();
        afficherTrains();
      }
    }

    // ===== Alarmes (m√™me si l'onglet est derri√®re) =====
    async function checkAlarme(){
      const now = new Date();
      const heureActuelle = now.toTimeString().slice(0,5);
      const jc = jourCourant();

      const snap = await db.collection("trains")
        .where("jour","==",jc)
        .where("horaire","==",heureActuelle)
        .get();

      snap.forEach(async doc => {
        const t = doc.data();
        if (!t.triggered) {
          await doc.ref.update({ triggered: true });

          // D√©marrer la boucle sonore (m√™me en arri√®re-plan si audioReady)
          if (audioReady) {
            try { alarme.currentTime = 0; await alarme.play(); } catch(e) {}
          }

          const message = `Train ${t.numero} (${jc} - ${t.horaire}) !`;

          // Notification syst√®me si autoris√©e
          if ("Notification" in window && Notification.permission === "granted") {
            try {
              const n = new Notification("üöÇ Alarme train", { body: message });
              n.onclick = () => window.focus();
            } catch(e) {}
          }

          // Popup bloquante ‚Üí le son continue tant qu'elle est ouverte
          alert(`üöÇ ${message}`);

          // √Ä la fermeture de la popup, on coupe la boucle
          alarme.pause();
          alarme.currentTime = 0;
        }
      });
    }

    // Reset des triggers √† minuit pile
    async function resetTriggers(){
      const snap = await db.collection("trains").get();
      const batchSize = 300;
      let batch = db.batch();
      let count = 0;
      snap.forEach(doc => {
        batch.update(doc.ref,{triggered:false});
        if(++count % batchSize === 0){ batch.commit(); batch = db.batch(); }
      });
      await batch.commit();
    }
    function msUntilMidnight() {
      const now = new Date();
      const tonight = new Date(now);
      tonight.setHours(24,0,0,0);
      return tonight - now;
    }

    // Timers
    setInterval(checkAlarme, 1000); // pr√©cision √† la minute
    setTimeout(() => {
      resetTriggers();
      setInterval(resetTriggers, 24*60*60*1000);
    }, msUntilMidnight());

    // Premier rendu
    afficherTrains();
  </script>
</body>
</html>
