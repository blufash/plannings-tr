<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Accord D√©part</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f4f6f9; --fg:#333; --brand:#0077cc; --card:#fff; --muted:#ddd; --shadow:0 0 4px rgba(0,0,0,.08); }

    /* layout */
    body{
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg); color: var(--fg);
      text-align: center; padding: 20px;
      min-height: 100vh; display: flex; flex-direction: column;
    }

    h1{ color: var(--brand); margin: 0 0 14px; display:flex; gap:10px; align-items:center; justify-content:center; }
    .tabs{ margin:14px 0; }
    .tab{ display:inline-block; margin:4px; padding:8px 12px; background:var(--muted); border-radius:7px; cursor:pointer; user-select:none; }
    .tab.active{ background:var(--brand); color:#fff; }

    form{
      margin:12px 0; background:var(--card); padding:10px; border-radius:10px;
      display:inline-flex; gap:8px; align-items:center; justify-content:center; align-self:center;
      box-shadow:var(--shadow);
    }
    input,button{ padding:8px 10px; border-radius:7px; border:1px solid #ccc; }
    #enableSound{ background:#ffe8b3; border-color:#e6c779; }

    ul{ list-style:none; padding:0; margin-top:12px; }
    li{
      background:#fff; margin:6px auto; padding:10px; border-radius:8px; width:min(520px,92%);
      display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow);
    }
    .actions button{ margin-left:6px; }

    /* lisibilit√© & √©tat */
    li span { font-size: 16px; }
    li.upcoming span { color:#111; font-weight:700; }
    li.past { opacity:.55; }
    li.past span { color:#555; font-weight:500; }
    .badge {
      font-size: 11px; padding:2px 6px; border-radius: 10px; margin-left: 8px;
      background:#eef1f6; color:#3b4a66; border:1px solid #dfe6f2;
    }

    /* footer */
    body > footer{
      margin-top:auto; background:#f4f4f4; color:#777; font-size:12px;
      padding:8px 0; text-align:center; border-top:1px solid #eee;
    }
  </style>
</head>
<body>

  <h1>üöÇ Accord D√©part üöÇ</h1>

  <div class="tabs" id="tabs"></div>

  <form id="f">
    <input id="num" type="text" placeholder="Num√©ro de train (ex: EVO5525)" pattern="[A-Za-z0-9]+" required />
    <input id="time" type="time" required />
    <button type="submit">Ajouter</button>
  </form>

  <div><button id="enableSound">üîä Activer son & notifications</button></div>

  <ul id="list"></ul>

  <!-- son de secours (mp3 local) -->
  <audio id="beepFile" src="sounds/alarme.mp3" preload="auto" loop style="display:none"></audio>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCJNVjAS8-hqW6KBcewBzUHXc6gbz1hj9c",
      authDomain: "accord-depart-48400.firebaseapp.com",
      projectId: "accord-depart-48400",
      storageBucket: "accord-depart-48400.appspot.com",
      messagingSenderId: "996894868266",
      appId: "1:996894868266:web:1829dd1f375ce99a099453",
      measurementId: "G-J636KCRMFY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- DOM ---
    const tabsEl  = document.getElementById('tabs');
    const listEl  = document.getElementById('list');
    const form    = document.getElementById('f');
    const inNum   = document.getElementById('num');
    const inTime  = document.getElementById('time');
    const btnEn   = document.getElementById('enableSound');
    const beepTag = document.getElementById('beepFile');

    // --- const ---
    const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
    const CATCHUP_MIN = 3; // rattrapage si l‚Äôonglet a ‚Äúdormi‚Äù

    // --- Audio (WebAudio loop + fallback <audio>) ---
    let ctx=null, gain=null, loopSrc=null, audioOk=false;
    let baseTitle=document.title, titleTimer=null;

    function useAudio(){
      if(!ctx){
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC();
        gain = ctx.createGain(); gain.connect(ctx.destination); gain.gain.value = 0;
      }
      if(ctx.state === "suspended") ctx.resume();
      return ctx;
    }

    // buffer 2s ‚Äúding-dong‚Äù (ind√©pendant des timers)
    function mkDingDong(c){
      const sr=c.sampleRate, dur=2, N=sr*dur|0;
      const b=c.createBuffer(1,N,sr), ch=b.getChannelData(0);
      const env=(t,a,r,L)=> t<a? t/a : t>(L-r)? (L-t)/r : 1;
      const dLen=0.45, dA=0.02, dR=0.25, dF=1000;
      const gOff=0.5, gLen=0.7, gA=0.02, gR=0.35, gF=400;
      for(let i=0;i<N;i++){
        const t=i/sr; let v=0;
        if(t<=dLen) v += Math.sin(2*Math.PI*dF*t)*0.30*env(t,dA,dR,dLen);
        const td=t-gOff;
        if(td>=0 && td<=gLen) v += Math.sin(2*Math.PI*gF*td)*0.35*env(td,gA,gR,gLen);
        ch[i]=v;
      }
      return b;
    }

    function startLoop(){
      useAudio();
      stopLoop();

      const buf = mkDingDong(ctx);
      loopSrc = ctx.createBufferSource();
      loopSrc.buffer = buf;
      loopSrc.loop   = true;
      loopSrc.connect(gain);
      loopSrc.start();

      gain.gain.cancelScheduledValues(ctx.currentTime);
      gain.gain.setTargetAtTime(1, ctx.currentTime, 0.05);

      try { beepTag.currentTime=0; beepTag.loop=true; beepTag.play(); } catch(_){}

      if(!titleTimer){
        titleTimer = setInterval(()=> {
          document.title = (document.title === baseTitle) ? ("üî∂ ALERTE ‚Äî " + baseTitle) : baseTitle;
        }, 700);
      }
    }

    function stopLoop(){
      if(loopSrc){ try{loopSrc.stop();}catch{} try{loopSrc.disconnect();}catch{} loopSrc=null; }
      if(ctx && gain) gain.gain.setTargetAtTime(0, ctx.currentTime, 0.1);
      try{ beepTag.pause(); beepTag.currentTime=0; beepTag.loop=false; }catch{}
      if(titleTimer){ clearInterval(titleTimer); titleTimer=null; document.title=baseTitle; }
    }

    btnEn.addEventListener('click', async () => {
      useAudio();
      try{
        // petit ‚Äúclick‚Äù pour d√©bloquer l‚Äôaudio
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.type="sine"; o.frequency.value=440; g.gain.value=0.0001;
        o.connect(g); g.connect(ctx.destination);
        const t=ctx.currentTime; o.start(t); o.stop(t+0.05);

        await beepTag.play(); beepTag.pause(); beepTag.currentTime=0;
        audioOk = true;
      }catch{
        alert("Autorise le son pour ce site dans ton navigateur.");
      }
      if("Notification" in window && Notification.permission!=="granted"){
        try{ await Notification.requestPermission(); }catch{}
      }
      btnEn.style.display="none";
    });

    // --- Jours + UI ---
    function getJour(){
      const d=new Date().getDay();
      return d===0 ? "Dimanche" : jours[d-1];
    }
    let jourSel = getJour();

    jours.forEach(j=>{
      const el=document.createElement('div');
      el.textContent=j; el.className="tab"+(j===jourSel?" active":"");
      el.onclick=()=>{ jourSel=j; syncTabs(); show(); };
      tabsEl.appendChild(el);
    });
    function syncTabs(){ [...tabsEl.children].forEach(t=>t.classList.toggle('active', t.textContent===jourSel)); }

    // --- localStorage (d√©dup / rattrapage / reset journalier) ---
    const dayKey = () => new Date().toISOString().slice(0,10);
    const rungKey = (d=dayKey()) => "rung_"+d;
    const lastKey = (d=dayKey()) => "lastMin_"+d;
    const resetKey = "ackResetDate"; // derni√®re date (YYYY-MM-DD) o√π on a reset les ack

    const hasRung = id => !!(JSON.parse(localStorage.getItem(rungKey())||"{}")[id]);
    function markRung(id){
      const k=rungKey(), m=JSON.parse(localStorage.getItem(k)||"{}"); m[id]=true; localStorage.setItem(k, JSON.stringify(m));
    }
    const getLast = () => { const v=localStorage.getItem(lastKey()); return v?+v:null; };
    const setLast = m => localStorage.setItem(lastKey(), String(m));

    // reset si on change de jour (pour localStorage)
    (function(){
      const k="visitDate", today=dayKey(), prev=localStorage.getItem(k);
      if(prev!==today){
        localStorage.setItem(k,today);
        if(prev){ localStorage.removeItem(rungKey(prev)); localStorage.removeItem(lastKey(prev)); }
      }
    })();

    // --- Helpers Firestore pour "Valid√©" ---
    const nowIso = () => new Date().toISOString();
    async function setAck(id, on){
      try {
        await db.collection("trains").doc(id).update(
          on ? { ack:true,  ackAt: nowIso() } :
               { ack:false, ackAt: firebase.firestore.FieldValue.delete() }
        );
      } catch(e) { console.warn("Ack error", e); }
    }

    // --- Reset auto quotidien des validations (ack=false) pour le jour courant ---
    function msUntilMidnight(){
      const n=new Date(), m=new Date(n); m.setHours(24,0,0,0); return m-n;
    }

    async function resetAcksFor(jour){
      try{
        const snap = await db.collection("trains").where("jour","==",jour).where("ack","==",true).get();
        const batchSize = 400; // Firestore batch limit ~500
        let ops = 0, batch = db.batch();
        snap.forEach(doc=>{
          batch.update(doc.ref, { ack:false, ackAt: firebase.firestore.FieldValue.delete() });
          ops++;
          if(ops % batchSize === 0){ batch.commit(); batch = db.batch(); }
        });
        await batch.commit();
      }catch(e){ console.warn("resetAcksFor error", e); }
    }

    async function dailyAckResetIfNeeded(){
      const today = dayKey();
      const last  = localStorage.getItem(resetKey);
      if(last !== today){
        await resetAcksFor(getJour());     // on reset pour la journ√©e actuelle
        localStorage.setItem(resetKey, today);
        // on nettoie aussi la d√©dup locale du jour (sonnette)
        localStorage.removeItem(rungKey(today));
        localStorage.removeItem(lastKey(today));
        show(); // refresh affichage (d√©sagrise tout)
      }
    }

    // planifie le prochain reset √† minuit (et tous les jours)
    function scheduleMidnightReset(){
      setTimeout(async ()=>{
        await dailyAckResetIfNeeded();
        scheduleMidnightReset(); // replanifie pour le lendemain
      }, msUntilMidnight());
    }

    // --- Liste ---
    async function show(){
      listEl.innerHTML="";
      try{
        const snap = await db.collection("trains").where("jour","==",jourSel).orderBy("timeValue").get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id, ...d.data()}));
        rows.forEach(render);
      }catch{
        const snap = await db.collection("trains").where("jour","==",jourSel).get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id, ...d.data()}));
        rows.sort((a,b)=>(a.timeValue ?? toMin(a.horaire)) - (b.timeValue ?? toMin(b.horaire)));
        rows.forEach(render);
        console.warn("Besoin d‚Äôun index Firestore (jour + timeValue) ? Clique ‚ÄúCreate index‚Äù, attends, recharge.");
      }
    }

    function render(t){
      const li=document.createElement('li');
      li.classList.add(t.ack ? 'past' : 'upcoming');

      const left=document.createElement('span');
      left.textContent = `Train ${t.numero} - ${t.horaire}`;
      if (t.ack) {
        const badge=document.createElement('span');
        badge.className='badge'; badge.textContent='Valid√©';
        left.appendChild(badge);
      }

      const act=document.createElement('div'); act.className='actions';
      const bAck=document.createElement('button');
      if (t.ack) {
        bAck.textContent="‚Ü©Ô∏è Annuler";
        bAck.title="Marquer comme non valid√©";
        bAck.onclick=async()=>{ await setAck(t.id,false); show(); };
      } else {
        bAck.textContent="‚úÖ Valider";
        bAck.title="Marquer comme valid√©";
        bAck.onclick=async()=>{ await setAck(t.id,true); show(); };
      }

      const bE=document.createElement('button'); bE.textContent="‚úèÔ∏è"; bE.onclick=()=>edit(t.id,t);
      const bD=document.createElement('button'); bD.textContent="üóëÔ∏è"; bD.onclick=()=>del(t.id);

      act.append(bAck,bE,bD);
      li.append(left, act);
      listEl.appendChild(li);
    }

    // --- CRUD ---
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const num=inNum.value.trim(), h=inTime.value;
      if(!/^[A-Za-z0-9]+$/.test(num) || !h) return;
      await db.collection("trains").add({ numero:num, horaire:h, jour:jourSel, timeValue: toMin(h), ack:false });
      form.reset(); show();
    });

    async function edit(id, t){
      const n=prompt("Nouveau num√©ro ?", t.numero);
      const h=prompt("Nouvel horaire (HH:MM) ?", t.horaire);
      if(n && /^\d{2}:\d{2}$/.test(h)){
        await db.collection("trains").doc(id).update({ numero:n, horaire:h, timeValue: toMin(h) });
        show();
      }
    }
    async function del(id){
      if(confirm("Supprimer ce train ?")){
        await db.collection("trains").doc(id).delete();
        show();
      }
    }

    // --- Alarme ---
    const toMin = hhmm => { const [H,M]=hhmm.split(':').map(Number); return H*60+M; };

    async function tick(){
      const now=new Date(), cur=now.getHours()*60+now.getMinutes(), j=getJour();
      const last=getLast(), left=Math.max(0, cur - CATCHUP_MIN), start=(last==null)? left : Math.min(cur, Math.max(last+1, left));
      if(start>cur){ setLast(cur); return; }

      let snap;
      try{
        snap = await db.collection("trains")
          .where("jour","==",j)
          .where("timeValue",">=",start)
          .where("timeValue","<=",cur)
          .orderBy("timeValue")
          .get();
      }catch{
        const all=await db.collection("trains").where("jour","==",j).get();
        const arr=[]; all.forEach(d=>{ const t=d.data(); if(t.timeValue>=start && t.timeValue<=cur) arr.push({id:d.id, ...t}); });
        arr.sort((a,b)=>a.timeValue-b.timeValue);
        for(const t of arr) await ring(t.id,t,j);
        setLast(cur);
        return;
      }

      const list=[]; snap.forEach(d=>list.push({id:d.id, ...d.data()}));
      for(const t of list) await ring(t.id,t,j);
      setLast(cur);
    }

    async function ring(id, t, j){
      if(hasRung(id)) return;

      try{ startLoop(); }catch{}

      const msg = `Train ${t.numero} (${j} - ${t.horaire}) !`;

      if("Notification" in window && Notification.permission==="granted"){
        try{
          const n=new Notification("üöÇ Alarme train", { body: msg, requireInteraction:true, tag:"train-"+id, renotify:true });
          n.onclick=()=>{ window.focus(); try{n.close();}catch{} };
        }catch{}
      }

      if(!document.hidden){
        // laisse 100ms au son pour d√©marrer, puis on acquitte
        setTimeout(async ()=>{
          alert("üöÇ "+msg);
          stopLoop();
          await setAck(id, true);
          show();
        }, 100);
      }

      markRung(id);
    }

    document.addEventListener("visibilitychange", ()=>{
      if(!document.hidden){
        if(loopSrc) stopLoop();
        tick();
      }
    });

    // --- init ---
    (async function(){
      await dailyAckResetIfNeeded(); // reset ‚Äúvalid√©‚Äù pour aujourd‚Äôhui si pas encore fait
      syncTabs();
      show();
      tick();
      setInterval(tick, 1000);
      scheduleMidnightReset();      // reset auto √† minuit
    })();

    // footer year
    document.addEventListener('DOMContentLoaded', ()=>{
      const y=document.getElementById('year');
      if(y) y.textContent=new Date().getFullYear();
    });
  </script>

  <footer>
    ¬© <span id="year"></span> ‚Äî Accord D√©part ‚Äî Conception et droits r√©serv√©s par Maxime Foerster ‚Äî Usage interne au PCD de Lutterbach.
    Toute reproduction ou diffusion non autoris√©e est interdite.
  </footer>
</body>
</html>
