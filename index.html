<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Accord Départ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6f9;--fg:#333;--brand:#0077cc;--card:#fff;--muted:#ddd;--shadow:0 0 4px rgba(0,0,0,.08);
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--fg);text-align:center;padding:20px;}
    h1{color:var(--brand);margin:0 0 14px;display:flex;gap:10px;align-items:center;justify-content:center}
    .tabs{margin:14px 0;}
    .tab{display:inline-block;margin:4px;padding:8px 12px;background:var(--muted);border-radius:7px;cursor:pointer;user-select:none;}
    .tab.active{background:var(--brand);color:#fff}
    form{margin:12px 0;background:var(--card);padding:10px;border-radius:10px;display:inline-flex;gap:8px;align-items:center;box-shadow:var(--shadow)}
    input,button{padding:8px 10px;border-radius:7px;border:1px solid #ccc}
    #enableSound{background:#ffe8b3;border-color:#e6c779}
    ul{list-style:none;padding:0;margin-top:12px}
    li{background:#fff;margin:6px auto;padding:10px;border-radius:8px;width:min(420px,92%);box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center}
    .actions button{margin-left:6px}


  body > footer {
    margin-top: auto;
    background: #f4f4f4;
    color: #777;
    font-size: 12px;
    padding: 6px 0;
  }
  </style>
</head>
<body>

  <h1>🚂 Accord Départ 🚂</h1>

  <div class="tabs" id="joursTabs"></div>

  <form id="trainForm">
    <input type="text" id="numero" placeholder="Numéro de train (ex: EVO5525)" pattern="[A-Za-z0-9]+" required />
    <input type="time" id="horaire" required />
    <button type="submit">Ajouter</button>
  </form>

  <!-- Bouton d’activation (obligatoire une fois / poste) -->
  <div><button id="enableSound">🔊 Activer son & notifications</button></div>

  <ul id="listeTrains"></ul>

  <!-- Fallback audio local (place ton fichier ici) -->
  <audio id="fallbackAlarm" src="sounds/alarme.mp3" preload="auto" loop style="display:none"></audio>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== CONFIG FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyCJNVjAS8-hqW6KBcewBzUHXc6gbz1hj9c",
      authDomain: "accord-depart-48400.firebaseapp.com",
      projectId: "accord-depart-48400",
      storageBucket: "accord-depart-48400.appspot.com",
      messagingSenderId: "996894868266",
      appId: "1:996894868266:web:1829dd1f375ce99a099453",
      measurementId: "G-J636KCRMFY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== CONSTANTES & REFS =====
    const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
    const tabs = document.getElementById('joursTabs');
    const liste = document.getElementById('listeTrains');
    const form = document.getElementById('trainForm');
    const enableBtn = document.getElementById('enableSound');
    const fallback = document.getElementById('fallbackAlarm');
    const CATCHUP_MINUTES = 3; // rattrapage max si onglet "dort"

    // ===== AUDIO: WebAudio (buffer loop) + fallback <audio> =====
    let audioCtx=null, gainNode=null, loopSource=null, audioReady=false;
    let baseTitle=document.title, titleTimer=null;

    function ensureAudio(){
      if(!audioCtx){
        const AC = window.AudioContext||window.webkitAudioContext;
        audioCtx = new AC();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        gainNode.gain.value = 0.0;
      }
      if(audioCtx.state==="suspended") audioCtx.resume();
    }

    // génère un buffer 2.0s "ding-dong" agréable, bouclable
    function makeDingDongBuffer(ctx){
      const sr = ctx.sampleRate;
      const dur = 2.0; // secondes
      const N = Math.floor(sr*dur);
      const buf = ctx.createBuffer(1, N, sr);
      const ch = buf.getChannelData(0);

      // fenêtres (enveloppes)
      function env(t, attack, release, length){
        if(t<attack) return t/attack;
        if(t>length-release) return Math.max(0,(length - t)/release);
        return 1;
      }

      // DING (1kHz) de 0.0s à 0.45s
      const dingLen = 0.45, dingA=0.02, dingR=0.25, dingF=1000;
      // DONG (400Hz) de 0.5s à 1.2s
      const dongStart = 0.5, dongLen=0.7, dongA=0.02, dongR=0.35, dongF=400;

      for(let i=0;i<N;i++){
        const t = i/sr;

        let v = 0;

        // ding
        if(t<=dingLen){
          const e = env(t, dingA, dingR, dingLen);
          v += Math.sin(2*Math.PI*dingF*t) * 0.30 * e;
        }

        // dong
        const td = t - dongStart;
        if(td>=0 && td<=dongLen){
          const e2 = env(td, dongA, dongR, dongLen);
          v += Math.sin(2*Math.PI*dongF*td) * 0.35 * e2;
        }

        ch[i] = v;
      }
      return buf;
    }

    function startTitleFlash(){
      if(titleTimer) return;
      let on=false;
      titleTimer = setInterval(()=>{ on=!on; document.title = on?("🔶 ALERTE — "+baseTitle):baseTitle; }, 700);
    }
    function stopTitleFlash(){
      if(titleTimer){ clearInterval(titleTimer); titleTimer=null; }
      document.title = baseTitle;
    }

    function startAlarmLoop(){
      ensureAudio();
      stopAlarmLoop(); // sécurité

      // 1) WebAudio: une seule source qui LOOP le buffer (indépendant des timers)
      const buf = makeDingDongBuffer(audioCtx);
      loopSource = audioCtx.createBufferSource();
      loopSource.buffer = buf;
      loopSource.loopStart = 0;
      loopSource.loopEnd   = buf.duration;
      loopSource.loop = true;
      loopSource.connect(gainNode);
      loopSource.start();

      // fade-in
      gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
      gainNode.gain.setTargetAtTime(1.0, audioCtx.currentTime, 0.05);

      // 2) Fallback mp3 en parallèle (si une policy bloque WebAudio en arrière-plan)
      try {
        fallback.currentTime = 0;
        fallback.loop = true;
        fallback.addEventListener('ended', () => fallback.play(), { once: false });
        fallback.play();
      } catch(_){}

      startTitleFlash();
    }

    function stopAlarmLoop(){
      if(loopSource){
        try{ loopSource.stop(); }catch(_){}
        try{ loopSource.disconnect(); }catch(_){}
        loopSource=null;
      }
      if(audioCtx && gainNode){
        gainNode.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.1);
      }
      try{ fallback.pause(); fallback.currentTime=0; }catch(_){}
      stopTitleFlash();
    }

    // Activation unique : débloque WebAudio + <audio>, demande notifications
    enableBtn.addEventListener("click", async ()=>{
      ensureAudio();
      try{
        // micro bip inaudible pour déverrouiller
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type="sine"; o.frequency.value=440; g.gain.value=0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime; o.start(t); o.stop(t+0.05);

        await fallback.play(); fallback.pause(); fallback.currentTime = 0;

        audioReady = true;
      }catch(e){
        alert("Autorise le son pour ce site dans ton navigateur.");
      }
      if("Notification" in window && Notification.permission!=="granted"){
        try{ await Notification.requestPermission(); }catch(e){}
      }
      enableBtn.style.display="none";
    });

    // ===== ONGLET & UI =====
    function jourCourant(){ const i=new Date().getDay(); return i===0?"Dimanche":jours[i-1]; }
    let jourActif = jourCourant();

    jours.forEach(jour=>{
      const tab=document.createElement('div');
      tab.textContent=jour; tab.className="tab"+(jour===jourActif?" active":"");
      tab.onclick=()=>{ jourActif=jour; majTabs(); afficherTrains(); };
      tabs.appendChild(tab);
    });
    function majTabs(){
      [...tabs.children].forEach(t=>t.classList.toggle('active', t.textContent===jourActif));
    }

    // ===== Helpers & mémoire locale =====
    function toTimeValue(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
    function todayKey(){ return new Date().toISOString().slice(0,10); } // YYYY-MM-DD
    // dédup locale
    function getRungSet(){ const k="rung_"+todayKey(); try{return JSON.parse(localStorage.getItem(k))||{}}catch{return{}} }
    function setRungSet(o){ localStorage.setItem("rung_"+todayKey(), JSON.stringify(o)); }
    function hasRung(id){ return !!getRungSet()[id]; }
    function markRung(id){ const s=getRungSet(); s[id]=true; setRungSet(s); }
    // rattrapage
    function lastCheckKey(){ return "lastCheckMin_"+todayKey(); }
    function getLastCheckedMinute(){ const v=localStorage.getItem(lastCheckKey()); return v?parseInt(v,10):null; }
    function setLastCheckedMinute(min){ localStorage.setItem(lastCheckKey(), String(min)); }
    // purge jour
    (function stampToday(){
      const k="lastVisitDate", now=todayKey(), prev=localStorage.getItem(k);
       if(prev!==now){
        localStorage.setItem(k, now);
        if(prev){
          localStorage.removeItem("rung_"+prev);
          localStorage.removeItem("lastCheckMin_"+prev);
        }
      }
    })();

    // ===== LISTE =====
    async function afficherTrains(){
      liste.innerHTML="";
      try{
        const snap = await db.collection("trains").where("jour","==",jourActif).orderBy("timeValue").get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
        rows.forEach(renderRow);
      }catch(e){
        const snap = await db.collection("trains").where("jour","==",jourActif).get();
        const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
        rows.sort((a,b)=>(a.timeValue ?? toTimeValue(a.horaire))-(b.timeValue ?? toTimeValue(b.horaire)));
        rows.forEach(renderRow);
        console.warn("⚠️ Crée l’index Firestore (jour + timeValue) si demandé.");
      }
    }
    function renderRow(t){
      const li=document.createElement('li');
      li.innerHTML=`<span>Train ${t.numero} - ${t.horaire}</span>`;
      const actions=document.createElement('div'); actions.className="actions";
      const bE=document.createElement('button'); bE.textContent="✏️"; bE.onclick=()=>modifierTrain(t.id,t);
      const bD=document.createElement('button'); bD.textContent="🗑️"; bD.onclick=()=>supprimerTrain(t.id);
      actions.append(bE,bD); li.appendChild(actions); liste.appendChild(li);
    }

    // ===== CRUD =====
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const numero=document.getElementById('numero').value.trim();
      const horaire=document.getElementById('horaire').value;
      if(!numero.match(/^[A-Za-z0-9]+$/) || !horaire) return;
      await db.collection("trains").add({ numero, horaire, jour:jourActif, timeValue: toTimeValue(horaire) });
      form.reset(); afficherTrains();
    });
    async function modifierTrain(id,t){
      const n=prompt("Nouveau numéro ?",t.numero);
      const h=prompt("Nouvel horaire (HH:MM) ?",t.horaire);
      if(n && /^\d{2}:\d{2}$/.test(h)){
        await db.collection("trains").doc(id).update({ numero:n, horaire:h, timeValue: toTimeValue(h) });
        afficherTrains();
      }
    }
    async function supprimerTrain(id){
      if(confirm("Êtes-vous sûr de vouloir supprimer ce train ?")){
        await db.collection("trains").doc(id).delete(); afficherTrains();
      }
    }

    // ===== ALARMES =====
    const CATCHUP = CATCHUP_MINUTES;
    async function checkAlarme(){
      const now=new Date();
      const nowMin=now.getHours()*60 + now.getMinutes();
      const jc=jourCourant();

      const last=getLastCheckedMinute();
      const leftBound=Math.max(0, nowMin - CATCHUP);
      const startMin=(last===null)? leftBound : Math.min(nowMin, Math.max(last+1, leftBound));
      if(startMin>nowMin){ setLastCheckedMinute(nowMin); return; }

      let snap;
      try{
        snap = await db.collection("trains")
          .where("jour","==",jc)
          .where("timeValue",">=",startMin)
          .where("timeValue","<=",nowMin)
          .orderBy("timeValue")
          .get();
      }catch(e){
        const all=await db.collection("trains").where("jour","==",jc).get();
        const arr=[]; all.forEach(d=>{ const t=d.data(); if(t.timeValue>=startMin && t.timeValue<=nowMin) arr.push({id:d.id,...t}); });
        arr.sort((a,b)=>a.timeValue-b.timeValue);
        for(const t of arr) await triggerAlarmOnce(t.id,t,jc);
        setLastCheckedMinute(nowMin);
        return;
      }

      const pending=[]; snap.forEach(d=>pending.push({id:d.id,...d.data()}));
      for(const t of pending) await triggerAlarmOnce(t.id,t,jc);
      setLastCheckedMinute(nowMin);
    }

    async function triggerAlarmOnce(docId,t,jc){
      if(hasRung(docId)) return;

      // démarre la boucle (WebAudio loop + fallback)
      try{ startAlarmLoop(); }catch(_){}

      const message=`Train ${t.numero} (${jc} - ${t.horaire}) !`;

      // Notification persistante (renotify)
      if("Notification" in window && Notification.permission==="granted"){
        try{
          const n=new Notification("🚂 Alarme train",{
            body:message, requireInteraction:true, tag:"alarme-train-"+docId, renotify:true
          });
          n.onclick=()=>{ window.focus(); try{n.close();}catch(_){}}; 
        }catch(_){}
      }

      // Si l’onglet est visible : acquittement + on coupe
      if(!document.hidden){
        alert("🚂 "+message);
        stopAlarmLoop();
      }

      // dédup locale
      markRung(docId);
    }

    document.addEventListener("visibilitychange", ()=>{
      if(!document.hidden){
        // si ça sonnait, coupe et recheck
        if(loopSource) stopAlarmLoop();
        checkAlarme();
      }
    });

    setInterval(checkAlarme, 1000);

    // Init
    (function init(){ majTabs(); afficherTrains(); checkAlarme(); })();
  </script>
<footer style="margin-top:32px;color:#777;font-size:12px">
  © 2025 — Accord Départ — Conception et droits réservés par Maxime Foerster — Usage interne au PCD de Lutterbach.
  Toute reproduction ou diffusion non autorisée est interdite.
</footer>

</body>
</html>
