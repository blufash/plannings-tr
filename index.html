<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning Trains</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; color:#333; text-align:center; padding:20px; }
    h1 { color:#0077cc; margin: 0 0 10px; }
    .tabs { margin:20px 0; }
    .tab { display:inline-block; margin:5px; padding:10px 15px; background:#ddd; border-radius:5px; cursor:pointer; user-select:none; }
    .tab.active { background:#0077cc; color:#fff; }
    form { margin:15px 0; background:#fff; padding:10px; border-radius:8px; display:inline-block; box-shadow:0 0 4px rgba(0,0,0,0.08); }
    input, button { padding:7px 10px; margin:5px; border-radius:5px; border:1px solid #ccc; }
    #enableSound { background:#ffe8b3; border-color:#e6c779; }
    ul { list-style:none; padding:0; }
    li { background:#fff; margin:6px auto; padding:10px; border-radius:6px; width:340px; box-shadow:0 0 4px rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; }
    .actions button { margin-left:6px; }
  </style>
</head>
<body>

  <h1>üöÇ Accord D√©part üöÇ</h1>

  <div class="tabs" id="joursTabs"></div>

  <form id="trainForm">
    <input type="text" id="numero" placeholder="Num√©ro de train (ex: EVO5525)" pattern="[A-Za-z0-9]+" required />
    <input type="time" id="horaire" required />
    <button type="submit">Ajouter</button>
  </form>

  <!-- Bouton pour autoriser son & notifications (obligatoire une fois) -->
  <div>
    <button id="enableSound">üîä Activer son & notifications</button>
  </div>

  <ul id="listeTrains"></ul>

  <!-- Firebase compat (pour site HTML simple) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Config Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCJNVjAS8-hqW6KBcewBzUHXc6gbz1hj9c",
      authDomain: "accord-depart-48400.firebaseapp.com",
      projectId: "accord-depart-48400",
      storageBucket: "accord-depart-48400.appspot.com",
      messagingSenderId: "996894868266",
      appId: "1:996894868266:web:1829dd1f375ce99a099453",
      measurementId: "G-J636KCRMFY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Constantes & refs =====
    const jours = ["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];
    const tabs = document.getElementById('joursTabs');
    const liste = document.getElementById('listeTrains');
    const form = document.getElementById('trainForm');
    const enableBtn = document.getElementById('enableSound');

    // Fen√™tre de rattrapage (minutes) quand l‚Äôonglet se ‚Äúr√©veille‚Äù
    const CATCHUP_MINUTES = 3;

    // ===== WebAudio (son en boucle m√™me onglet arri√®re-plan apr√®s activation) =====
    let audioCtx = null, gainNode = null, beepInterval = null, audioReady = false;
    function ensureAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        gainNode.gain.value = 0.0;
      }
      if (audioCtx.state === "suspended") audioCtx.resume();
    }
    function startAlarmLoop() {
      ensureAudio();
      stopAlarmLoop(); // s√©curit√©
      const playPattern = () => {
        // bip 1
        const o1 = audioCtx.createOscillator(); o1.type="sine"; o1.frequency.value=880;
        const g1 = audioCtx.createGain(); g1.gain.value=0;
        o1.connect(g1); g1.connect(gainNode);
        const t = audioCtx.currentTime;
        g1.gain.setValueAtTime(0, t);
        g1.gain.linearRampToValueAtTime(0.18, t+0.03);
        g1.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
        o1.start(t); o1.stop(t+0.4);

        // bip 2 d√©cal√©
        const o2 = audioCtx.createOscillator(); o2.type="sine"; o2.frequency.value=740;
        const g2 = audioCtx.createGain(); g2.gain.value=0;
        o2.connect(g2); o2.connect(gainNode);
        g2.connect(gainNode);
        const t2 = t + 0.5;
        g2.gain.setValueAtTime(0, t2);
        g2.gain.linearRampToValueAtTime(0.18, t2+0.03);
        g2.gain.exponentialRampToValueAtTime(0.0001, t2+0.35);
        o2.start(t2); o2.stop(t2+0.4);
      };
      playPattern();
      beepInterval = setInterval(playPattern, 1500);
      gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
      gainNode.gain.setTargetAtTime(0.9, audioCtx.currentTime, 0.02);
      startTitleFlash();
    }
    function stopAlarmLoop() {
      if (beepInterval) { clearInterval(beepInterval); beepInterval = null; }
      if (audioCtx && gainNode) {
        gainNode.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.05);
      }
      stopTitleFlash();
    }

    // Titre clignotant (orange) tant que l‚Äôalarme est active
    let titleTimer=null, baseTitle=document.title;
    function startTitleFlash(){
      if (titleTimer) return;
      let on=false;
      titleTimer = setInterval(()=> {
        on=!on;
        document.title = on ? "üî∂ ALERTE ‚Äî " + baseTitle : baseTitle;
      }, 700);
    }
    function stopTitleFlash(){
      if (titleTimer){ clearInterval(titleTimer); titleTimer=null; }
      document.title = baseTitle;
    }

    // Activation son & notifications
    enableBtn.addEventListener("click", async () => {
      ensureAudio();
      try {
        // micro bip silencieux pour d√©verrouiller
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type="sine"; o.frequency.value=440; g.gain.value=0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime; o.start(t); o.stop(t+0.05);
        audioReady = true;
      } catch(e) {
        alert("Autorise le son pour ce site dans ton navigateur.");
      }
      if ("Notification" in window && Notification.permission !== "granted") {
        try { await Notification.requestPermission(); } catch(e) {}
      }
      enableBtn.style.display = "none";
    });

    // ===== Jour courant & onglets =====
    function jourCourant() {
      const i = new Date().getDay(); // 0=Dimanche, 1=Lundi...
      return i === 0 ? "Dimanche" : jours[i-1];
    }
    let jourActif = jourCourant();

    jours.forEach(jour => {
      const tab = document.createElement('div');
      tab.textContent = jour;
      tab.classList.add('tab');
      if (jour === jourActif) tab.classList.add('active');
      tab.onclick = () => { jourActif = jour; majTabs(); afficherTrains(); };
      tabs.appendChild(tab);
    });
    function majTabs(){
      Array.from(tabs.children).forEach(t => t.classList.toggle('active', t.textContent===jourActif));
    }

    // ===== Helpers & m√©moire locale =====
    function toTimeValue(hhmm){ const [h,m] = hhmm.split(':').map(Number); return h*60 + m; }
    function todayKey(){ return new Date().toISOString().slice(0,10); } // YYYY-MM-DD
    // d√©dup locale par jour
    function getRungSet(){ const k="rung_"+todayKey(); try{return JSON.parse(localStorage.getItem(k))||{}}catch{return{}} }
    function setRungSet(o){ localStorage.setItem("rung_"+todayKey(), JSON.stringify(o)); }
    function hasRung(id){ return !!getRungSet()[id]; }
    function markRung(id){ const s=getRungSet(); s[id]=true; setRungSet(s); }
    // rattrapage : m√©morise derni√®re minute trait√©e
    function lastCheckKey(){ return "lastCheckMin_"+todayKey(); }
    function getLastCheckedMinute(){ const v=localStorage.getItem(lastCheckKey()); return v?parseInt(v,10):null; }
    function setLastCheckedMinute(min){ localStorage.setItem(lastCheckKey(), String(min)); }
    // si la date a chang√© depuis la derni√®re visite, on repart propre
    (function purgeIfDateChanged(){
      const stampKey="lastVisitDate";
      const prev=localStorage.getItem(stampKey);
      const now=todayKey();
      if(prev!==now){
        // on nettoie toutes les cl√©s *_YYYY-MM-DD d'hier si besoin :
        // simple: on reset rung et lastCheck pour aujourd'hui
        localStorage.removeItem("rung_"+now); // assure une cl√© propre
        localStorage.removeItem("lastCheckMin_"+now);
        localStorage.setItem(stampKey, now);
      }
    })();

    // ===== Affichage (tri par timeValue) =====
    async function afficherTrains(){
      liste.innerHTML = "";
      try {
        const snap = await db.collection("trains")
          .where("jour","==",jourActif)
          .orderBy("timeValue")
          .get();
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
        rows.forEach(renderRow);
      } catch(e) {
        const snap = await db.collection("trains").where("jour","==",jourActif).get();
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
        rows.sort((a,b) => (a.timeValue ?? toTimeValue(a.horaire)) - (b.timeValue ?? toTimeValue(b.horaire)));
        rows.forEach(renderRow);
        console.warn("‚ö†Ô∏è Si Firestore demande un index (jour + timeValue), clique 'Create index', attends 1‚Äì2 min, puis recharge.");
      }
    }
    function renderRow(t){
      const li = document.createElement('li');
      li.innerHTML = `<span>Train ${t.numero} - ${t.horaire}</span>`;
      const actions = document.createElement('div');
      actions.className="actions";

      const btnEdit = document.createElement('button');
      btnEdit.textContent="‚úèÔ∏è";
      btnEdit.onclick = () => modifierTrain(t.id, t);

      const btnDel = document.createElement('button');
      btnDel.textContent="üóëÔ∏è";
      btnDel.onclick = () => supprimerTrain(t.id);

      actions.appendChild(btnEdit);
      actions.appendChild(btnDel);
      li.appendChild(actions);
      liste.appendChild(li);
    }

    // ===== CRUD =====
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const numero = document.getElementById('numero').value.trim();
      const horaire = document.getElementById('horaire').value;
      if(!numero.match(/^[A-Za-z0-9]+$/) || !horaire) return;

      await db.collection("trains").add({
        numero,
        horaire,
        jour: jourActif,
        timeValue: toTimeValue(horaire)
      });
      form.reset();
      afficherTrains();
    });
    async function modifierTrain(id, train){
      const nouveauNumero = prompt("Nouveau num√©ro ?", train.numero);
      const nouvelHoraire = prompt("Nouvel horaire (HH:MM) ?", train.horaire);
      if(nouveauNumero && /^\d{2}:\d{2}$/.test(nouvelHoraire)){
        await db.collection("trains").doc(id).update({
          numero: nouveauNumero,
          horaire: nouvelHoraire,
          timeValue: toTimeValue(nouvelHoraire)
        });
        afficherTrains();
      }
    }
    async function supprimerTrain(id){
      if(confirm("√ätes-vous s√ªr de vouloir supprimer ce train ?")){
        await db.collection("trains").doc(id).delete();
        afficherTrains();
      }
    }

    // ===== Alarmes (rattrapage + arri√®re-plan) =====
    async function checkAlarme(){
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      const jc = jourCourant();

      // borne gauche : derni√®re minute check√©e OU now - CATCHUP_MINUTES
      const last = getLastCheckedMinute();
      const leftBound = Math.max(0, nowMin - CATCHUP_MINUTES);
      const startMin = (last === null) ? leftBound : Math.min(nowMin, Math.max(last + 1, leftBound));

      if (startMin > nowMin) { setLastCheckedMinute(nowMin); return; }

      let snap;
      try {
        snap = await db.collection("trains")
          .where("jour","==",jc)
          .where("timeValue",">=", startMin)
          .where("timeValue","<=", nowMin)
          .orderBy("timeValue")
          .get();
      } catch(e) {
        const all = await db.collection("trains").where("jour","==",jc).get();
        const arr = [];
        all.forEach(d => {
          const t = d.data();
          if (t.timeValue >= startMin && t.timeValue <= nowMin) arr.push({id:d.id, ...t});
        });
        arr.sort((a,b)=>a.timeValue-b.timeValue);
        for (const t of arr) { await triggerAlarmOnce(t.id, t, jc); }
        setLastCheckedMinute(nowMin);
        return;
      }

      const pending = [];
      snap.forEach(doc => pending.push({ id: doc.id, ...doc.data() }));
      for (const t of pending) { await triggerAlarmOnce(t.id, t, jc); }
      setLastCheckedMinute(nowMin);
    }

    async function triggerAlarmOnce(docId, t, jc){
      if (hasRung(docId)) return;

      if (audioReady) { try { startAlarmLoop(); } catch(e){} }

      const message = `Train ${t.numero} (${jc} - ${t.horaire}) !`;

      // Notification persistante (renotify si d√©j√† pr√©sente)
      if ("Notification" in window && Notification.permission === "granted") {
        try {
          const n = new Notification("üöÇ Alarme train", {
            body: message,
            requireInteraction: true, // reste jusqu'√† action
            tag: "alarme-train-" + docId,
            renotify: true
          });
          n.onclick = () => { window.focus(); try{ n.close(); }catch(e){} };
        } catch(e){}
      }

      // Si l‚Äôonglet est visible, on force un acquittement via alert (et on coupe apr√®s)
      if (!document.hidden) {
        alert("üöÇ " + message);
        stopAlarmLoop();
      }
      // Si l‚Äôonglet est cach√© : le son + notif tournent jusqu‚Äô√† ce que l‚Äôagent revienne
      // et clique OK (quand il revient, checkAlarme sera relanc√© via visibilitychange)

      // D√©dup locale
      markRung(docId);
    }

    // Re-check imm√©diat quand l‚Äôonglet redevient visible
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        // coupe l‚Äôalarme si elle tournait en arri√®re-plan et notifie tout de suite
        if (beepInterval) { stopAlarmLoop(); }
        checkAlarme();
      }
    });

    // Timers (1s = pr√©cision √† la minute ; throttling g√©r√© par rattrapage)
    setInterval(checkAlarme, 1000);

    // ===== Premier rendu =====
    (function init(){
      // construire les onglets
      majTabs();
      afficherTrains();
      // premier check d√®s le chargement
      checkAlarme();
    })();
  </script>
</body>
</html>
